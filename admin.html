<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Admin Login Portal for Rationing Management" />
  <meta name="keywords" content="Admin login" />
  <title>Admin Login</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <link rel="stylesheet" href="admin.css" />

  <link rel="icon" type="image/x-icon" href="assets/images/Logo.jpg" />
</head>

<body>
  <!-- Logo -->
  <div class="logo-container" style="text-align:center;margin-bottom:20px;">
    <img src="assets/images/Logo.jpg" alt="App Logo" style="width:150px;height:auto;" />
  </div>

  <!-- ================== SIGN UP FORM ================== -->
  <div class="container" id="signup" style="display:none;">
    <h1 class="form-title">Admin Registration</h1>
    <form id="signupForm">
      <div id="signUpMessage" class="messageDiv" style="display:none;"></div>

      <div class="input-group">
        <i class="fas fa-user"></i>
        <input type="text" id="fName" placeholder="First Name" required />
      </div>

      <div class="input-group">
        <i class="fas fa-user"></i>
        <input type="text" id="lName" placeholder="Last Name" required />
      </div>

      <div class="input-group">
        <i class="fas fa-envelope"></i>
        <input type="email" id="rEmail" placeholder="Email" required />
      </div>

      <div class="input-group">
        <i class="fas fa-map-marker-alt"></i>
        <input type="text" id="Area" placeholder="Area" required />
      </div>

      <div class="input-group">
        <i class="fas fa-mobile"></i>
        <input type="tel" id="MNumber" placeholder="Mobile Number" pattern="[0-9]{10}" required />
      </div>

      <div class="input-group">
        <i class="fas fa-lock"></i>
        <input type="password" id="rPassword" placeholder="Password" required />
      </div>

      <button type="submit" class="btn">Register Admin</button>
    </form>

    <p class="or">----------or--------</p>
    <div class="links">
      <p>Already Have an Admin Account?</p>
      <button id="signInButton" class="switch-btn">Sign In</button>
    </div>
  </div>

  <!-- ================== SIGN IN FORM ================== -->
  <div class="container" id="signIn">
    <h1 class="form-title">Admin Login</h1>
    <form id="signinForm">
      <div id="signInMessage" class="messageDiv" style="display:none;"></div>

      <div class="input-group">
        <i class="fas fa-envelope"></i>
        <input type="email" id="email" placeholder="Admin Email" required />
      </div>

      <div class="input-group">
        <i class="fas fa-lock"></i>
        <input type="password" id="password" placeholder="Password" required />
      </div>

      <div class="remember-me">
        <input type="checkbox" id="rememberMe" />
        <label for="rememberMe">Remember Me</label>
      </div>

      <p class="recover">
        <a href="#" id="forgotPassword">Forgot Password?</a>
      </p>

      <button type="submit" class="btn">Sign In</button>
    </form>

    <p class="or">----------or--------</p>
    <div class="links">
      <p>Don't have an Admin account yet?</p>
      <button id="signUpButton" class="switch-btn">Register Now</button>
    </div>
  </div>

  <!-- ================== LOADING / MODALS ================== -->
  <div id="loadingSpinner" class="loading-spinner" style="display:none;">
    <div class="spinner"></div>
  </div>

  <div id="errorModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Error</h2>
      <p id="errorMessage"></p>
    </div>
  </div>

  <div id="successModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Success</h2>
      <p id="successMessage"></p>
    </div>
  </div>

  <footer class="footer">
    <p>&copy; 2025 Ration Management System. All rights reserved.</p>
  </footer>

  <!-- ================== MERGED SCRIPT ================== -->
  <script type="module">
    /* -------------------- FIREBASE SETUP -------------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAcfUIEfXQinRokagk0a_e4h1uoz3qt3cQ",
      authDomain: "parchuna-wala.firebaseapp.com",
      projectId: "parchuna-wala",
      storageBucket: "parchuna-wala.firebasestorage.app",
      messagingSenderId: "55576084655",
      appId: "1:55576084655:web:93343d235f30963fbad45a",
      measurementId: "G-6EHGD82VM2",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* -------------------- DOM ELEMENTS -------------------- */
    const signUpDiv = document.getElementById("signup");
    const signInDiv = document.getElementById("signIn");
    const signUpButton = document.getElementById("signUpButton");
    const signInButton = document.getElementById("signInButton");
    const signUpForm = document.getElementById("signupForm");
    const signInForm = document.getElementById("signinForm");
    const loadingSpinner = document.getElementById("loadingSpinner");

    /* -------------------- UTILITIES -------------------- */
    function showLoading() { loadingSpinner.style.display = "flex"; }
    function hideLoading() { loadingSpinner.style.display = "none"; }
    function showMessage(msg, divId) {
      const d = document.getElementById(divId);
      d.innerHTML = msg;
      d.style.display = "block";
      setTimeout(() => (d.style.display = "none"), 4000);
    }
    function switchForm(hide, show) {
      hide.style.opacity = "0";
      setTimeout(() => {
        hide.style.display = "none";
        show.style.display = "block";
        setTimeout(() => (show.style.opacity = "1"), 50);
      }, 300);
    }

    /* -------------------- FORM SWITCH -------------------- */
    signUpButton.addEventListener("click", () => switchForm(signInDiv, signUpDiv));
    signInButton.addEventListener("click", () => switchForm(signUpDiv, signInDiv));

    /* -------------------- AUTH STATE -------------------- */
    onAuthStateChanged(auth, (user) => {
      console.log("Auth state changed:", user ? user.email : "No user");
    });

    /* -------------------- SIGN IN -------------------- */
    signInForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      showLoading();
      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage("Login successful!", "signInMessage");
        console.log("User logged in:", email);
        window.location.href = "admin selection.html";
      } catch (err) {
        console.error("Login error:", err);
        showMessage(err.message, "signInMessage");
      } finally {
        hideLoading();
      }
    });

    /* -------------------- SIGN UP -------------------- */
    signUpForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("rEmail").value.trim();
      const password = document.getElementById("rPassword").value.trim();
      const userData = {
        email,
        firstName: document.getElementById("fName").value.trim(),
        lastName: document.getElementById("lName").value.trim(),
        area: document.getElementById("Area").value.trim(),
        mobileNumber: document.getElementById("MNumber").value.trim(),
      };
      showLoading();
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "users", userCred.user.uid), userData);
        showMessage("Account created successfully!", "signUpMessage");
        console.log("User registered:", email);
        switchForm(signUpDiv, signInDiv);
      } catch (err) {
        console.error("Signup error:", err);
        showMessage(err.message, "signUpMessage");
      } finally {
        hideLoading();
      }
    });

    /* -------------------- REMEMBER ME -------------------- */
    const rememberMe = document.getElementById("rememberMe");
    rememberMe.addEventListener("change", () => {
      if (rememberMe.checked) {
        localStorage.setItem("rememberMe", "true");
        localStorage.setItem("savedEmail", document.getElementById("email").value);
      } else {
        localStorage.removeItem("rememberMe");
        localStorage.removeItem("savedEmail");
      }
    });

    window.addEventListener("load", () => {
      if (localStorage.getItem("rememberMe") === "true") {
        rememberMe.checked = true;
        const savedEmail = localStorage.getItem("savedEmail");
        if (savedEmail) document.getElementById("email").value = savedEmail;
      }
    });

    /* -------------------- LOGOUT HELPER -------------------- */
    async function logout() {
      await signOut(auth);
      window.location.href = "admin.html";
    }

    /* -------------------- STYLE FIXES -------------------- */
    const style = document.createElement("style");
    style.textContent = `
      .input-group { position: relative; margin-bottom: 15px; }
      .password-toggle {
        position: absolute; right: 10px; top: 50%;
        transform: translateY(-50%); background:none; border:none; cursor:pointer;
      }
      .container { transition: opacity 0.3s ease-in-out; }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
